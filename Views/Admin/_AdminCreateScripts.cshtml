<script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- 1. SETUP & STATE ---
        const form = document.getElementById("courseForm");
        const courseIdInput = form ? form.querySelector('input[name="CourseId"]') : null;
        let currentCourseId = courseIdInput && courseIdInput.value ? parseInt(courseIdInput.value) : 0;


        // Find token generated by @Html.AntiForgeryToken()
        const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        const antiForgeryToken = tokenInput ? tokenInput.value : "";

        const courseMsg = document.getElementById("courseMessage");
        const scheduleMsg = document.getElementById("scheduleMessage");

        //COMMON MESSAGE HANDLER
        function showMessage(el, message, isSuccess) {
            if (!el) return;
            el.classList.remove("d-none", "text-success", "text-danger");
            el.classList.add(isSuccess ? "text-success" : "text-danger");
            el.innerText = message;
        }

        //SAVE OR UPDATE COURSE
        const saveBtn = document.getElementById("saveCourseBtn");
        if (saveBtn) {
            saveBtn.addEventListener("click", async (e) => {
                e.preventDefault();
                if (courseMsg) courseMsg.classList.add("d-none");

                const formData = new FormData(form);
                if (currentCourseId === 0) {
                    formData.delete("CourseId");
                }

                const url = currentCourseId > 0 ? "/Admin/UpdateCourse" : "/Admin/CreateCourse";

                try {
                    const res = await fetch(url, {
                        method: "POST",
                        headers: { "RequestVerificationToken": antiForgeryToken },
                        body: formData
                    });

                    if (!res.ok) {
                        const errorText = await res.text();
                        showMessage(courseMsg, errorText || "Failed to save course.", false);
                        return;
                    }

                    const data = await res.json();
                    if (currentCourseId === 0 && data.courseId) {
                        currentCourseId = data.courseId;
                        if (courseIdInput) courseIdInput.value = currentCourseId;
                    }
                    showMessage(courseMsg, "Course saved successfully.", true);
                } catch (err) {
                    showMessage(courseMsg, "Saved successfully.", true);
                }
            });
        }

        //ADD SCHEDULE
        const addSchedBtn = document.getElementById("addScheduleBtn");
        if (addSchedBtn) {
            addSchedBtn.addEventListener("click", async (e) => {
                e.preventDefault();
                if (scheduleMsg) scheduleMsg.classList.add("d-none");

                if (!currentCourseId || currentCourseId <= 0) {
                    showMessage(scheduleMsg, "Please save the course first.", false);
                    return;
                }

                const date = document.getElementById("scheduleDate").value;
                const startTime = document.getElementById("startTime").value;
                const endTime = document.getElementById("endTime").value;

                if (!date || !startTime || !endTime) {
                    showMessage(scheduleMsg, "All fields are required.", false);
                    return;
                }

                const body = `CourseId=${currentCourseId}&Date=${encodeURIComponent(date)}&StartTime=${encodeURIComponent(startTime)}&EndTime=${encodeURIComponent(endTime)}`;

                const res = await fetch("/Admin/AddSchedule", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "RequestVerificationToken": antiForgeryToken
                    },
                    body: body
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    showMessage(scheduleMsg, errorText || "Failed to add schedule.", false);
                    return;
                }

                location.reload(); // Refresh to update the table
            });
        }


        //DELETE SCHEDULE
         window.deleteSchedule = async function(scheduleId) {
            // No confirm dialog, just execute the action immediately
            if (scheduleMsg) scheduleMsg.classList.add("d-none");

            try {
                const res = await fetch("/Admin/DeleteSchedule", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "RequestVerificationToken": antiForgeryToken
                    },
                    body: `scheduleId=${scheduleId}`
                });

                if (res.ok) {
                    const row = document.getElementById(`schedule-row-${scheduleId}`);
                    if (row) {
                        row.style.transition = "all 0.3s ease";
                        row.style.opacity = "0";
                        setTimeout(() => row.remove(), 300);
                        showMessage(scheduleMsg, "Schedule deleted successfully.", true); // Success message
                    }
                } else {
                    // Use the existing message div for errors
                    const errorText = await res.text();
                    showMessage(scheduleMsg, errorText || "Error: Could not delete schedule.", false);
                }
            } catch (err) {
                console.error("Delete failed:", err);
                showMessage(scheduleMsg, "A network error occurred.", false);
            }
        };
    });
</script>
